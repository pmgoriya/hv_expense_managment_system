# API Documentation

| Endpoint | HTTP Method | Purpose | Role Access | Request Payload | Response | Schema Tables | Notes |
|----------|------------|---------|------------|----------------|----------|--------------|-------|
| `/api/login` | POST | Authenticate users via Google OAuth | All | `{code}` (Google OAuth token) | 200: `{jwt, user_id}`<br>401: Unauthorized | users | Requires @humanventures email. JWT includes permissions (via user_roles, role_permissions). |
| `/api/logout` | POST | Invalidate JWT session | All | None | 200: Success | None | Ensures secure session termination. Requires JWT. |
| `/api/profile` | GET | Retrieve logged-in user's details | All | None | 200: `{first_name, last_name, email, department_id, roles: [{id, name}], permissions: [{module, action}]}`<br>403: Unauthenticated | users, departments, user_roles, roles, role_permissions, permissions | Includes dynamic roles/permissions for UI (e.g., show approval options). Requires JWT. |
| `/api/reimbursements` | POST | Create a reimbursement request | Permission: Reimbursement.create | `{expense_date, cost_category_id, purpose_id, description, amount, ref_bill_number, bill_attached}` (multipart) | 201: `{id, status: "Pending"}`<br>400: Invalid data<br>403: Unauthorized | reimbursement_requests, request_updates | Creates request_updates (status_id=1, updated_by_id=NULL). bill_attached as file. Sets employee_id to authenticated user. |
| `/api/reimbursements` | GET | List reimbursement requests | Permissions: Reimbursement.view_own, Reimbursement.view_team, Reimbursement.approve_final | None | 200: `[{id, expense_date, cost_category_name, purpose_name, description, amount, ref_bill_number, status_name, updated_by_email, updated_at}]`<br>403: Unauthorized | reimbursement_requests, request_updates, cost_categories, purposes, statuses, users | Query params: `scope=me` |
| `/api/reimbursements/{id}/updates` | POST | Approve or reject a reimbursement request | Permissions: Reimbursement.approve_team, Reimbursement.approve_final | `{status_id, reason}` (reason required if status=Rejected) | 200: `{status: "ManagerApproved"}`<br>400: Invalid status<br>403: Unauthorized<br>404: Not found | request_updates, statuses, users | approve_team: Pending → ManagerApproved/Rejected. approve_final: ManagerApproved → FinalApproved/Rejected. Sets updated_by_id. Reason NULL unless Rejected. |
| `/api/reimbursements/{id}/pay` | POST | Mark reimbursement as Paid | Permission: Reimbursement.pay | None | 200: `{status: "Paid"}`<br>403: Unauthorized<br>404: Not found | request_updates, advance_balances | Creates request_updates (status_id=5, updated_by_id=user). Adjusts advance_balances for offset. Requires FinalApproved status. |
| `/api/advances` | POST | Create an advance request | Permission: Advance.create | `{request_date, start_date, end_date, cost_category_id, purpose_id, description, amount}` | 201: `{id, status: "Pending"}`<br>400: Invalid data<br>403: Unauthorized | advance_requests, request_updates | Creates request_updates (status_id=1, updated_by_id=NULL). Sets employee_id to user. |
| `/api/advances` | GET | List advance requests | Permissions: Advance.view_own, Advance.view_team, Advance.approve_final | None | 200: `[{id, request_date, start_date, end_date, cost_category_name, purpose_name, description, amount, status_name, updated_by_email, updated_at}]`<br>403: Unauthorized | advance_requests, request_updates, cost_categories, purposes, statuses, users | Query params: `scope=me` |
| `/api/advances/{id}/updates` | POST | Approve or reject an advance request | Permissions: Advance.approve_team, Advance.approve_final | `{status_id, reason}` (reason if Rejected) | 200: `{status: "ManagerApproved"}`<br>400: Invalid status<br>403: Unauthorized<br>404: Not found | request_updates, statuses, users | approve_team: Pending → ManagerApproved/Rejected. approve_final: ManagerApproved → FinalApproved/Rejected. Sets updated_by_id. |
| `/api/advances/{id}/disburse` | POST | Mark advance as Disbursed | Permission: Advance.disburse | None | 200: `{status: "Disbursed"}`<br>403: Unauthorized<br>404: Not found | request_updates, advance_balances | Creates request_updates (status_id=6, updated_by_id=user). Updates advance_balances. Requires FinalApproved status. |
| `/api/balances` | GET | Retrieve advance balances | Permissions: Balance.view_own, Balance.view_team, Balance.view_all | None | 200: `[{employee_id, first_name, last_name, balance}]`<br>403: Unauthorized | advance_balances, users | Query params: `scope=me` |
| `/api/dashboard` | GET | Retrieve dashboard metrics | Permissions: Reimbursement.view_own, Advance.view_own, Reimbursement.view_team, Advance.view_team, Balance.view_all | None | 200: `{pending_reimbursements: N, pending_advances: M, team_pending: N, manager_approved: N, advance_balance: X}`<br>403: Unauthorized | reimbursement_requests, advance_requests, request_updates, advance_balances, users | Query params: `scope=me` |
| `/api/cost-categories` | GET | List available cost categories | All | None | 200: `[{id, name}]` | cost_categories | Returns Product, Office Travel, Others. Used for form dropdowns. No auth required (public data). |
| `/api/cost-categories` | POST | Create a cost category | Permission: Master.edit | `{name}` | 201: `{id, name}`<br>400: Invalid data<br>403: Unauthorized | cost_categories | Allows Admin to add categories (e.g., "Training"). Requires JWT. |
| `/api/purposes` | GET | List purposes, filterable by category | All | None | 200: `[{id, name, cost_category_id}]` | purposes | Query param: cost_category_id (e.g., Product → Purchase). Supports form dropdowns. No auth required. |
| `/api/purposes` | POST | Create a purpose | Permission: Master.edit | `{name, cost_category_id}` | 201: `{id, name, cost_category_id}`<br>400: Invalid data<br>403: Unauthorized | purposes | Adds purposes (e.g., "Training Session"). cost_category_id nullable. Requires JWT. |
| `/api/statuses` | GET | List valid request statuses | All | None | 200: `[{id, name, is_reimbursement, is_advance}]` | statuses | Returns Pending, ManagerApproved, etc. Helps UI validate workflows. No auth required. |
| `/api/roles` | GET | List roles | Permission: Master.edit | None | 200: `[{id, name, description}]`<br>403: Unauthorized | roles | Supports admin UI for role management. Requires JWT. |
| `/api/roles` | POST | Create a role | Permission: Master.edit | `{name, description}` | 201: `{id, name, description}`<br>400: Invalid data<br>403: Unauthorized | roles | Allows Admin to define roles (e.g., "Auditor"). Requires JWT. |
| `/api/roles/{id}/permissions` | POST | Assign permissions to a role | Permission: Master.edit | `{permission_ids: [1, 2]}` | 200: `{role_id, permission_ids}`<br>400: Invalid IDs<br>403: Unauthorized<br>404: Role not found | role_permissions, permissions | Adds permissions (e.g., Report.view) to role. Creates role_permissions entries. Requires JWT. |
| `/api/users` | POST | Create a user | Permission: Master.edit | `{first_name, last_name, email, department_id, manager_id}` | 201: `{id, email}`<br>400: Invalid data<br>403: Unauthorized | users, departments | Allows Admin to add users (e.g., "Dave"). manager_id nullable. Requires JWT. |
| `/api/user_roles` | POST | Assign roles to a user | Permission: Master.edit | `{user_id, role_id}` | 200: `{user_id, role_id}`<br>400: Invalid IDs<br>403: Unauthorized | user_roles, users, roles | Assigns roles (e.g., "Employee" to Dave). Creates user_roles entry. Requires JWT. |
| `/api/permissions` | GET | List available permissions | Permission: Master.edit | None | 200: `[{id, module, action, description}]`<br>403: Unauthorized | permissions | Supports admin UI for permission assignment. Requires JWT. |
| `/api/audit/{request_id}` | GET | View request history | Permission: Report.view | None | 200: `[{request_type, status_name, reason, updated_by_email, updated_at}]`<br>403: Unauthorized<br>404: Not found | request_updates, statuses, users | Shows request_updates for reimbursement/advance. Supports MIS/audit trail. Requires JWT. |
| `/api/reports/requests` | GET | Generate request summary | Permission: Report.view | None | 200: `[{department_id, status_name, total_amount, count}]`<br>403: Unauthorized | reimbursement_requests, advance_requests, request_updates, users, departments | Query params: department_id, status, date_range. Aggregates for MIS (e.g., total Pending). Requires JWT. |
